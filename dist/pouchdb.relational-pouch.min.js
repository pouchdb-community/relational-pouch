!function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{var t;t="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this,t.RelationalPouch=e()}}(function(){return function e(t,n,r){function o(u,c){if(!n[u]){if(!t[u]){var s="function"==typeof require&&require;if(!c&&s)return s(u,!0);if(i)return i(u,!0);var a=new Error("Cannot find module '"+u+"'");throw a.code="MODULE_NOT_FOUND",a}var f=n[u]={exports:{}};t[u][0].call(f.exports,function(e){var n=t[u][1][e];return o(n?n:e)},f,f.exports,e,t,n,r)}return n[u].exports}for(var i="function"==typeof require&&require,u=0;u<r.length;u++)o(r[u]);return o}({1:[function(e,t,n){"use strict";function r(){this.store={}}function o(){this.store=new r}n.Map=r,n.Set=o,r.prototype.mangle=function(e){if("string"!=typeof e)throw new TypeError("key must be a string but Got "+e);return"$"+e},r.prototype.unmangle=function(e){return e.substring(1)},r.prototype.get=function(e){var t=this.mangle(e);return t in this.store?this.store[t]:void 0},r.prototype.set=function(e,t){var n=this.mangle(e);return this.store[n]=t,!0},r.prototype.has=function(e){var t=this.mangle(e);return t in this.store},r.prototype.delete=function(e){var t=this.mangle(e);return t in this.store&&(delete this.store[t],!0)},r.prototype.forEach=function(e){var t=this,n=Object.keys(t.store);n.forEach(function(n){var r=t.store[n];n=t.unmangle(n),e(r,n)})},o.prototype.add=function(e){return this.store.set(e,!0)},o.prototype.has=function(e){return this.store.has(e)},o.prototype.delete=function(e){return this.store.delete(e)}},{}],2:[function(e,t,n){"use strict";function r(e){var t=new Error(e);return t.status=400,t}function o(e,t){var n=e.replace("_","")+"_";if("number"==typeof t){for(t=t.toString();t.length<p;)t="0"+t;n+=d+"_"+t}else n+="undefined"==typeof t?h:"object"==typeof t?v:y+"_"+t;return n}function i(e){var t=e.indexOf("_"),n=e.charAt(t+1),r=e.substring(t+3);return n===d?parseInt(r,10):r}var u=e("./pouch-utils"),c=u.extend,s=u.Promise,a=e("./collections"),f=e("./uuid"),l=e("uniq"),p=16,h="0",d="1",y="2",v="3";n.setSchema=function(e){function t(e,t){t=c(!0,{},t);var n={};t.rev&&(n._rev=t.rev,delete t.rev),t.attachments&&(n._attachments=t.attachments,delete t.attachments);var r=t.id||f();return delete t.id,n._id=o(e.documentType,r),e.relations&&Object.keys(e.relations).forEach(function(n){var r=e.relations[n],o=Object.keys(r)[0];if("belongsTo"===o)t[n]&&"undefined"!=typeof t[n].id&&(t[n]=t[n].id);else{var i=r[o];if(i.options&&i.options.queryInverse)return void delete t[n];if(t[n]){var u=t[n].map(function(e){return e&&"undefined"!=typeof e.id?e.id:e});t[n]=u}else t[n]=[]}}),n.data=t,n}function n(e){var t=e.data;return t.id=i(e._id),t.rev=e._rev,e._attachments&&(t.attachments=e._attachments),t}function p(e){if(!I.has(e))throw r("unknown type: "+JSON.stringify(e));return I.get(e)}function h(e,n){var r,o=p(e);return s.resolve().then(function(){return r=t(o,n),q.put(r)}).then(function(e){var t={};return t[o.plural]=[c(!0,n,{id:i(e.id),rev:e.rev})],t})}function d(e,n){var r,o=p(e);return s.resolve().then(function(){return r=t(o,n),r={_id:r._id,_rev:r._rev,_deleted:!0},q.put(r)}).then(function(){return{deleted:!0}})}function y(e,t,n){var r=p(e),i={include_docs:!0};return"undefined"==typeof t||null===t?(i.startkey=o(r.documentType),i.endkey=o(r.documentType,{})):Array.isArray(t)?i.keys=t.map(function(e){return o(r.documentType,e)}):"object"==typeof t?("undefined"==typeof t.startkey||null===t.startkey?i.startkey=o(r.documentType):i.startkey=o(r.documentType,t.startkey),"undefined"==typeof t.endkey||null===t.endkey?i.endkey=o(r.documentType,{}):i.endkey=o(r.documentType,t.endkey),"undefined"!=typeof t.limit&&null!==t.limit&&(i.limit=t.limit),"undefined"!=typeof t.skip&&null!==t.skip&&(i.skip=t.skip)):i.key=o(r.documentType,t),q.allDocs(i).then(v.bind(this,e,n))}function v(e,t,n){return g(e,t,n.rows.map(function(e){if(e.doc&&!e.value.deleted)return e.doc}))}function m(e,t){return g(e,new a.Map,t)}function g(e,t,r){var o=p(e);return t.has(e)||t.set(e,new a.Map),s.resolve().then(function(){var i=r.map(function(r){var i=n(r);t.get(e).set(JSON.stringify(i.id),i);var u=[];return Object.keys(o.relations||{}).forEach(function(e){var n=o.relations[e],r=Object.keys(n)[0],a=n[r],f={};if("string"!=typeof a){if(f=a.options||{},f.async)return;f.queryInverse&&delete i[e],a=a.type}if("belongsTo"===r){var l=i[e];"undefined"!=typeof l&&u.push(s.resolve().then(function(){if(!t.has(a)||!t.get(a).has(JSON.stringify(l)))return{relatedType:a,relatedIds:[l]}}))}else{if(f.queryInverse)return E(a,f.queryInverse,i.id,t);var p=s.resolve(c(!0,[],i[e]));u.push(p.then(function(e){if("undefined"!=typeof e&&e.length){for(var n=e.length-1;n>=0;n--){var r=e[n];t.has(a)&&t.get(a).has(JSON.stringify(r))&&delete e[n]}if(e=e.filter(function(e){return"undefined"!=typeof e}),e.length)return{relatedType:a,relatedIds:e}}}))}}),s.all(u)});return s.all(i)}).then(function(e){var n={};return e.forEach(function(e){e.forEach(function(e){e&&(n[e.relatedType]=(n[e.relatedType]||[]).concat(e.relatedIds))})}),u.series(Object.keys(n).map(function(e){var r=l(n[e]);return function(){return y(e,r,t)}})).then(function(){var e={};return t.forEach(function(t,n){var r=p(n),o=e[r.plural]=[];t.forEach(function(e){o.push(e)})}),e})})}function w(e,t,n,r,u){var a=o(e,t.id),f=p(e);return s.resolve().then(function(){return q.putAttachment(a,n,t.rev,r,u)}).then(function(e){var n={};return n[f.plural]=[c(!0,t,{id:i(e.id),rev:e.rev})],n})}function b(e,t,n){var r=o(e,t.id),u=p(e);return s.resolve().then(function(){return q.removeAttachment(r,n,t.rev)}).then(function(e){var n={};return n[u.plural]=[c(!0,t,{id:i(e.id),rev:e.rev})],n})}function T(e,t,n,r){return r=r||{},s.resolve().then(function(){return q.getAttachment(o(e,t),n,r)})}function j(e,t){return s.resolve().then(function(){return h(e,t)})}function k(e,t){return s.resolve().then(function(){return y(p(e).singular,t,new a.Map)})}function E(e,t,n,r){var o={_id:{$gt:A({type:e}),$lt:A({type:e,id:{}})}};return o["data."+t]=n,q.find({selector:o}).then(function(t){return g(e,r,t.docs)})}function O(e,t,n){return E(e,t,n,new a.Map)}function x(e,t){return s.resolve().then(function(){return d(e,t)})}function _(t){var n=t.indexOf("_"),r=t.substring(0,n),o=i(t),u=I.get(r);if(!u){var c=e.filter(function(e){return e.documentType===r});c.length>0&&(r=c[0].singular)}return{type:r,id:o}}function A(e){var t=e.type,n=I.get(t);return n&&(t=n.documentType),o(t,e.id)}var q=this,I=new a.Map;e.forEach(function(e){I.set(e.singular,e),I.set(e.plural,e)}),e.forEach(function(e){e.documentType=e.documentType||e.singular}),e.forEach(function(e){if(e.relations){if(!Object.keys(e.relations).length)throw new Error("Invalid relations for: "+e);Object.keys(e.relations).forEach(function(t){var n=e.relations[t];if(1!==Object.keys(n).length)throw new Error("Invalid relationship definition for: "+t);var r=Object.keys(n)[0],o=n[r];if("string"!=typeof o&&(o=o.type),!I.get(o))throw new Error("Unknown entity type: "+o);if("belongsTo"!==r&&"hasMany"!==r)throw new Error("Invalid relationship type for "+t+": "+r)})}}),q.rel={save:j,find:k,findHasMany:O,del:x,getAttachment:T,putAttachment:w,removeAttachment:b,parseDocID:_,makeDocID:A,parseRelDocs:m}},"undefined"!=typeof window&&window.PouchDB&&window.PouchDB.plugin(n)},{"./collections":1,"./pouch-utils":3,"./uuid":4,uniq:11}],3:[function(e,t,n){(function(t){"use strict";var r=e("pouchdb-promise");n.once=function(e){var t=!1;return n.getArguments(function(n){if(t)throw console.trace(),new Error("once called  more than once");t=!0,e.apply(this,n)})},n.getArguments=function(e){return function(){for(var t=arguments.length,n=new Array(t),r=-1;++r<t;)n[r]=arguments[r];return e.call(this,n)}},n.toPromise=function(e){return n.getArguments(function(o){var i,u=this,c="function"==typeof o[o.length-1]&&o.pop();c&&(i=function(e,n){t.nextTick(function(){c(e,n)})});var s=new r(function(t,r){try{var i=n.once(function(e,n){e?r(e):t(n)});o.push(i),e.apply(u,o)}catch(e){r(e)}});return i&&s.then(function(e){i(null,e)},i),s.cancel=function(){return this},s})},n.series=function(e){var t=n.Promise.resolve(),r=new Array(e.length);return e.forEach(function(n,o){t=t.then(e[o]).then(function(e){r[o]=e})}),t.then(function(){return r})},n.inherits=e("inherits"),n.Promise=r,n.extend=e("pouchdb-extend")}).call(this,e("_process"))},{_process:5,inherits:6,"pouchdb-extend":7,"pouchdb-promise":8}],4:[function(e,t,n){"use strict";function r(e){return 0|Math.random()*e}function o(e,t){t=t||i.length;var n="",o=-1;if(e){for(;++o<e;)n+=i[r(t)];return n}for(;++o<36;)switch(o){case 8:case 13:case 18:case 23:n+="-";break;case 19:n+=i[3&r(16)|8];break;default:n+=i[r(16)]}return n}var i="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split("");t.exports=o},{}],5:[function(e,t,n){function r(){throw new Error("setTimeout has not been defined")}function o(){throw new Error("clearTimeout has not been defined")}function i(e){if(l===setTimeout)return setTimeout(e,0);if((l===r||!l)&&setTimeout)return l=setTimeout,setTimeout(e,0);try{return l(e,0)}catch(t){try{return l.call(null,e,0)}catch(t){return l.call(this,e,0)}}}function u(e){if(p===clearTimeout)return clearTimeout(e);if((p===o||!p)&&clearTimeout)return p=clearTimeout,clearTimeout(e);try{return p(e)}catch(t){try{return p.call(null,e)}catch(t){return p.call(this,e)}}}function c(){v&&d&&(v=!1,d.length?y=d.concat(y):m=-1,y.length&&s())}function s(){if(!v){var e=i(c);v=!0;for(var t=y.length;t;){for(d=y,y=[];++m<t;)d&&d[m].run();m=-1,t=y.length}d=null,v=!1,u(e)}}function a(e,t){this.fun=e,this.array=t}function f(){}var l,p,h=t.exports={};!function(){try{l="function"==typeof setTimeout?setTimeout:r}catch(e){l=r}try{p="function"==typeof clearTimeout?clearTimeout:o}catch(e){p=o}}();var d,y=[],v=!1,m=-1;h.nextTick=function(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var n=1;n<arguments.length;n++)t[n-1]=arguments[n];y.push(new a(e,t)),1!==y.length||v||i(s)},a.prototype.run=function(){this.fun.apply(null,this.array)},h.title="browser",h.browser=!0,h.env={},h.argv=[],h.version="",h.versions={},h.on=f,h.addListener=f,h.once=f,h.off=f,h.removeListener=f,h.removeAllListeners=f,h.emit=f,h.binding=function(e){throw new Error("process.binding is not supported")},h.cwd=function(){return"/"},h.chdir=function(e){throw new Error("process.chdir is not supported")},h.umask=function(){return 0}},{}],6:[function(e,t,n){"function"==typeof Object.create?t.exports=function(e,t){e.super_=t,e.prototype=Object.create(t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}})}:t.exports=function(e,t){e.super_=t;var n=function(){};n.prototype=t.prototype,e.prototype=new n,e.prototype.constructor=e}},{}],7:[function(e,t,n){"use strict";function r(e){return null===e?String(e):"object"==typeof e||"function"==typeof e?a[h.call(e)]||"object":typeof e}function o(e){return null!==e&&e===e.window}function i(e){if(!e||"object"!==r(e)||e.nodeType||o(e))return!1;try{if(e.constructor&&!d.call(e,"constructor")&&!d.call(e.constructor.prototype,"isPrototypeOf"))return!1}catch(e){return!1}var t;for(t in e);return void 0===t||d.call(e,t)}function u(e){return"function"===r(e)}function c(){for(var e=[],t=-1,n=arguments.length,r=new Array(n);++t<n;)r[t]=arguments[t];var o={};e.push({args:r,result:{container:o,key:"key"}});for(var i;i=e.pop();)s(e,i.args,i.result);return o.key}function s(e,t,n){var r,o,c,s,a,f,l,p=t[0]||{},h=1,d=t.length,v=!1,m=/\d+/;for("boolean"==typeof p&&(v=p,p=t[1]||{},h=2),"object"==typeof p||u(p)||(p={}),d===h&&(p=this,--h);h<d;h++)if(null!=(r=t[h])){l=y(r);for(o in r)if(!(o in Object.prototype)){if(l&&!m.test(o))continue;if(c=p[o],s=r[o],p===s)continue;v&&s&&(i(s)||(a=y(s)))?(a?(a=!1,f=c&&y(c)?c:[]):f=c&&i(c)?c:{},e.push({args:[v,f,s],result:{container:p,key:o}})):void 0!==s&&(y(r)&&u(s)||(p[o]=s))}}n.container[n.key]=p}for(var a={},f=["Boolean","Number","String","Function","Array","Date","RegExp","Object","Error"],l=0;l<f.length;l++){var p=f[l];a["[object "+p+"]"]=p.toLowerCase()}var h=a.toString,d=a.hasOwnProperty,y=Array.isArray||function(e){return"array"===r(e)};t.exports=c},{}],8:[function(e,t,n){"use strict";function r(e){return e&&"object"==typeof e&&"default"in e?e.default:e}var o=r(e("lie")),i="function"==typeof Promise?Promise:o;t.exports=i},{lie:9}],9:[function(e,t,n){"use strict";function r(){}function o(e){if("function"!=typeof e)throw new TypeError("resolver must be a function");this.state=g,this.queue=[],this.outcome=void 0,e!==r&&s(this,e)}function i(e,t,n){this.promise=e,"function"==typeof t&&(this.onFulfilled=t,this.callFulfilled=this.otherCallFulfilled),"function"==typeof n&&(this.onRejected=n,this.callRejected=this.otherCallRejected)}function u(e,t,n){d(function(){var r;try{r=t(n)}catch(t){return y.reject(e,t)}r===e?y.reject(e,new TypeError("Cannot resolve promise with itself")):y.resolve(e,r)})}function c(e){var t=e&&e.then;if(e&&"object"==typeof e&&"function"==typeof t)return function(){t.apply(e,arguments)}}function s(e,t){function n(t){i||(i=!0,y.reject(e,t))}function r(t){i||(i=!0,y.resolve(e,t))}function o(){t(r,n)}var i=!1,u=a(o);"error"===u.status&&n(u.value)}function a(e,t){var n={};try{n.value=e(t),n.status="success"}catch(e){n.status="error",n.value=e}return n}function f(e){return e instanceof this?e:y.resolve(new this(r),e)}function l(e){var t=new this(r);return y.reject(t,e)}function p(e){function t(e,t){function r(e){u[t]=e,++c!==o||i||(i=!0,y.resolve(a,u))}n.resolve(e).then(r,function(e){i||(i=!0,y.reject(a,e))})}var n=this;if("[object Array]"!==Object.prototype.toString.call(e))return this.reject(new TypeError("must be an array"));var o=e.length,i=!1;if(!o)return this.resolve([]);for(var u=new Array(o),c=0,s=-1,a=new this(r);++s<o;)t(e[s],s);return a}function h(e){function t(e){n.resolve(e).then(function(e){i||(i=!0,y.resolve(c,e))},function(e){i||(i=!0,y.reject(c,e))})}var n=this;if("[object Array]"!==Object.prototype.toString.call(e))return this.reject(new TypeError("must be an array"));var o=e.length,i=!1;if(!o)return this.resolve([]);for(var u=-1,c=new this(r);++u<o;)t(e[u]);return c}var d=e("immediate"),y={},v=["REJECTED"],m=["FULFILLED"],g=["PENDING"];t.exports=o,o.prototype.catch=function(e){return this.then(null,e)},o.prototype.then=function(e,t){if("function"!=typeof e&&this.state===m||"function"!=typeof t&&this.state===v)return this;var n=new this.constructor(r);if(this.state!==g){var o=this.state===m?e:t;u(n,o,this.outcome)}else this.queue.push(new i(n,e,t));return n},i.prototype.callFulfilled=function(e){y.resolve(this.promise,e)},i.prototype.otherCallFulfilled=function(e){u(this.promise,this.onFulfilled,e)},i.prototype.callRejected=function(e){y.reject(this.promise,e)},i.prototype.otherCallRejected=function(e){u(this.promise,this.onRejected,e)},y.resolve=function(e,t){var n=a(c,t);if("error"===n.status)return y.reject(e,n.value);var r=n.value;if(r)s(e,r);else{e.state=m,e.outcome=t;for(var o=-1,i=e.queue.length;++o<i;)e.queue[o].callFulfilled(t)}return e},y.reject=function(e,t){e.state=v,e.outcome=t;for(var n=-1,r=e.queue.length;++n<r;)e.queue[n].callRejected(t);return e},o.resolve=f,o.reject=l,o.all=p,o.race=h},{immediate:10}],10:[function(e,t,n){(function(e){"use strict";function n(){f=!0;for(var e,t,n=l.length;n;){for(t=l,l=[],e=-1;++e<n;)t[e]();n=l.length}f=!1}function r(e){1!==l.push(e)||f||o()}var o,i=e.MutationObserver||e.WebKitMutationObserver;if(i){var u=0,c=new i(n),s=e.document.createTextNode("");c.observe(s,{characterData:!0}),o=function(){s.data=u=++u%2}}else if(e.setImmediate||"undefined"==typeof e.MessageChannel)o="document"in e&&"onreadystatechange"in e.document.createElement("script")?function(){var t=e.document.createElement("script");t.onreadystatechange=function(){n(),t.onreadystatechange=null,t.parentNode.removeChild(t),t=null},e.document.documentElement.appendChild(t)}:function(){setTimeout(n,0)};else{var a=new e.MessageChannel;a.port1.onmessage=n,o=function(){a.port2.postMessage(0)}}var f,l=[];t.exports=r}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],11:[function(e,t,n){"use strict";function r(e,t){for(var n=1,r=e.length,o=e[0],i=e[0],u=1;u<r;++u)if(i=o,o=e[u],t(o,i)){if(u===n){n++;continue}e[n++]=o}return e.length=n,e}function o(e){for(var t=1,n=e.length,r=e[0],o=e[0],i=1;i<n;++i,o=r)if(o=r,r=e[i],r!==o){if(i===t){t++;continue}e[t++]=r}return e.length=t,e}function i(e,t,n){return 0===e.length?e:t?(n||e.sort(t),r(e,t)):(n||e.sort(),o(e))}t.exports=i},{}]},{},[2])(2)});
