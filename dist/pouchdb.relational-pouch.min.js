!function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this).RelationalPouch=e()}}(function(){return function e(t,n,r){function o(u,c){if(!n[u]){if(!t[u]){var s="function"==typeof require&&require;if(!c&&s)return s(u,!0);if(i)return i(u,!0);var a=new Error("Cannot find module '"+u+"'");throw a.code="MODULE_NOT_FOUND",a}var f=n[u]={exports:{}};t[u][0].call(f.exports,function(e){var n=t[u][1][e];return o(n||e)},f,f.exports,e,t,n,r)}return n[u].exports}for(var i="function"==typeof require&&require,u=0;u<r.length;u++)o(r[u]);return o}({1:[function(e,t,n){"use strict";function r(){this.store={}}function o(){this.store=new r}n.Map=r,n.Set=o,r.prototype.mangle=function(e){if("string"!=typeof e)throw new TypeError("key must be a string but Got "+e);return"$"+e},r.prototype.unmangle=function(e){return e.substring(1)},r.prototype.get=function(e){var t=this.mangle(e);return t in this.store?this.store[t]:void 0},r.prototype.set=function(e,t){var n=this.mangle(e);return this.store[n]=t,!0},r.prototype.has=function(e){return this.mangle(e)in this.store},r.prototype.delete=function(e){var t=this.mangle(e);return t in this.store&&(delete this.store[t],!0)},r.prototype.forEach=function(e){var t=this;Object.keys(t.store).forEach(function(n){var r=t.store[n];n=t.unmangle(n),e(r,n)})},o.prototype.add=function(e){return this.store.set(e,!0)},o.prototype.has=function(e){return this.store.has(e)},o.prototype.delete=function(e){return this.store.delete(e)}},{}],2:[function(e,t,n){"use strict";var r=e("./pouch-utils"),o=r.extend,i=r.Promise,u=e("./collections"),c=e("./uuid"),s=e("uniq");var a=16,f="0",l="1",h="2",p="3";function d(e,t){var n=e.replace("_","")+"_";if("number"==typeof t){for(t=t.toString();t.length<a;)t="0"+t;n+=l+"_"+t}else n+=void 0===t?f:"object"==typeof t?p:h+"_"+t;return n}function v(e){var t=e.indexOf("_"),n=e.charAt(t+1),r=e.substring(t+3);return n===l?parseInt(r,10):r}n.setSchema=function(e){var t=this,n=new u.Map;function a(e,t){var n={};(t=o(!0,{},t)).rev&&(n._rev=t.rev,delete t.rev),t.attachments&&(n._attachments=t.attachments,delete t.attachments);var r=t.id||c();return delete t.id,n._id=d(e.documentType,r),e.relations&&Object.keys(e.relations).forEach(function(n){var r=e.relations[n],o=Object.keys(r)[0];if("belongsTo"===o)t[n]&&void 0!==t[n].id&&(t[n]=t[n].id);else{var i=r[o];if(i.options&&i.options.queryInverse)return void delete t[n];if(t[n]){var u=t[n].map(function(e){return e&&void 0!==e.id?e.id:e});t[n]=u}else t[n]=[]}}),n.data=t,n}function f(e){if(!n.has(e))throw t="unknown type: "+JSON.stringify(e),(r=new Error(t)).status=400,r;var t,r;return n.get(e)}function l(e,n,r){var o=f(e),i={include_docs:!0};return void 0===n||null===n?(i.startkey=d(o.documentType),i.endkey=d(o.documentType,{})):Array.isArray(n)?i.keys=n.map(function(e){return d(o.documentType,e)}):"object"==typeof n?(void 0===n.startkey||null===n.startkey?i.startkey=d(o.documentType):i.startkey=d(o.documentType,n.startkey),void 0===n.endkey||null===n.endkey?i.endkey=d(o.documentType,{}):i.endkey=d(o.documentType,n.endkey),void 0!==n.limit&&null!==n.limit&&(i.limit=n.limit),void 0!==n.skip&&null!==n.skip&&(i.skip=n.skip)):i.key=d(o.documentType,n),t.allDocs(i).then(function(e,t,n){return h(e,t,n.rows.filter(function(e){return e.doc&&!e.value.deleted}).map(function(e){return e.doc}))}.bind(t,e,r))}function h(e,t,n){var c=f(e);return t.has(e)||t.set(e,new u.Map),i.resolve().then(function(){var r=n.map(function(n){var r,u,s=((u=(r=n).data).id=v(r._id),u.rev=r._rev,r._attachments&&(u.attachments=r._attachments),u);t.get(e).set(JSON.stringify(s.id),s);var a=[];return Object.keys(c.relations||{}).forEach(function(e){var n=c.relations[e],r=Object.keys(n)[0],u=n[r],f={};if("string"!=typeof u){if((f=u.options||{}).async)return;f.queryInverse&&delete s[e],u=u.type}if("belongsTo"===r){var l=s[e];void 0!==l&&a.push(i.resolve().then(function(){if(!t.has(u)||!t.get(u).has(JSON.stringify(l)))return{relatedType:u,relatedIds:[l]}}))}else{if(f.queryInverse)return void a.push(p(u,f.queryInverse,s.id,t).then(function(){}));var h=o(!0,[],s[e]);void 0!==h&&h.length&&a.push(i.resolve().then(function(){for(var e=h.length-1;e>=0;e--){var n=h[e];t.has(u)&&t.get(u).has(JSON.stringify(n))&&delete h[e]}if((h=h.filter(function(e){return void 0!==e})).length)return{relatedType:u,relatedIds:h}}))}}),i.all(a)});return i.all(r)}).then(function(e){var n={};return e.forEach(function(e){e.forEach(function(e){e&&(n[e.relatedType]=(n[e.relatedType]||[]).concat(e.relatedIds))})}),r.series(Object.keys(n).map(function(e){var r=s(n[e]);return function(){return l(e,r,t)}})).then(function(){var e={};return t.forEach(function(t,n){var r=f(n),o=e[r.plural]=[];t.forEach(function(e){o.push(e)})}),e})})}function p(e,n,r,o){var i={_id:{$gt:y({type:e}),$lt:y({type:e,id:{}})}};return i["data."+n]=r,t.find({selector:i}).then(function(t){return h(e,o,t.docs)})}function y(e){var t=e.type,r=n.get(t);return r&&(t=r.documentType),d(t,e.id)}e.forEach(function(e){n.set(e.singular,e),n.set(e.plural,e)}),e.forEach(function(e){e.documentType=e.documentType||e.singular}),e.forEach(function(e){if(e.relations){if(!Object.keys(e.relations).length)throw new Error("Invalid relations for: "+e);Object.keys(e.relations).forEach(function(t){var r=e.relations[t];if(1!==Object.keys(r).length)throw new Error("Invalid relationship definition for: "+t);var o=Object.keys(r)[0],i=r[o];if("string"!=typeof i&&(i=i.type),!n.get(i))throw new Error("Unknown entity type: "+i);if("belongsTo"!==o&&"hasMany"!==o)throw new Error("Invalid relationship type for "+t+": "+o)})}}),t.rel={save:function(e,n){return i.resolve().then(function(){return r=n,c=f(e),i.resolve().then(function(){return u=a(c,r),t.put(u)}).then(function(e){var t={};return t[c.plural]=[o(!0,r,{id:v(e.id),rev:e.rev})],t});var r,u,c})},find:function(e,t){return i.resolve().then(function(){return l(f(e).singular,t,new u.Map)})},findHasMany:function(e,t,n){return p(e,t,n,new u.Map)},del:function(e,n){return i.resolve().then(function(){return r=n,u=f(e),i.resolve().then(function(){return o={_id:(o=a(u,r))._id,_rev:o._rev,_deleted:!0},t.put(o)}).then(function(){return{deleted:!0}});var r,o,u})},getAttachment:function(e,n,r,o){return o=o||{},i.resolve().then(function(){return t.getAttachment(d(e,n),r,o)})},putAttachment:function(e,n,r,u,c){var s=d(e,n.id),a=f(e);return i.resolve().then(function(){return t.putAttachment(s,r,n.rev,u,c)}).then(function(e){var t={};return t[a.plural]=[o(!0,n,{id:v(e.id),rev:e.rev})],t})},removeAttachment:function(e,n,r){var u=d(e,n.id),c=f(e);return i.resolve().then(function(){return t.removeAttachment(u,r,n.rev)}).then(function(e){var t={};return t[c.plural]=[o(!0,n,{id:v(e.id),rev:e.rev})],t})},parseDocID:function(t){var r=t.indexOf("_"),o=t.substring(0,r),i=v(t);if(!n.get(o)){var u=e.filter(function(e){return e.documentType===o});u.length>0&&(o=u[0].singular)}return{type:o,id:i}},makeDocID:y,parseRelDocs:function(e,t){return h(e,new u.Map,t)},isDeleted:function(e,n){var r=f(e);return t.get(d(r.documentType,n)).then(function(e){return!!e._deleted}).catch(function(e){return"deleted"===e.reason||null})}}},"undefined"!=typeof window&&window.PouchDB&&window.PouchDB.plugin(n)},{"./collections":1,"./pouch-utils":3,"./uuid":4,uniq:11}],3:[function(e,t,n){(function(t){"use strict";var r=e("pouchdb-promise");n.once=function(e){var t=!1;return n.getArguments(function(n){if(t)throw console.trace(),new Error("once called  more than once");t=!0,e.apply(this,n)})},n.getArguments=function(e){return function(){for(var t=arguments.length,n=new Array(t),r=-1;++r<t;)n[r]=arguments[r];return e.call(this,n)}},n.toPromise=function(e){return n.getArguments(function(o){var i,u=this,c="function"==typeof o[o.length-1]&&o.pop();c&&(i=function(e,n){t.nextTick(function(){c(e,n)})});var s=new r(function(t,r){try{var i=n.once(function(e,n){e?r(e):t(n)});o.push(i),e.apply(u,o)}catch(e){r(e)}});return i&&s.then(function(e){i(null,e)},i),s.cancel=function(){return this},s})},n.series=function(e){var t=n.Promise.resolve(),r=new Array(e.length);return e.forEach(function(n,o){t=t.then(e[o]).then(function(e){r[o]=e})}),t.then(function(){return r})},n.inherits=e("inherits"),n.Promise=r,n.extend=e("pouchdb-extend")}).call(this,e("_process"))},{_process:10,inherits:6,"pouchdb-extend":8,"pouchdb-promise":9}],4:[function(e,t,n){"use strict";var r="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split("");function o(e){return 0|Math.random()*e}t.exports=function(e,t){t=t||r.length;var n="",i=-1;if(e){for(;++i<e;)n+=r[o(t)];return n}for(;++i<36;)switch(i){case 8:case 13:case 18:case 23:n+="-";break;case 19:n+=r[3&o(16)|8];break;default:n+=r[o(16)]}return n}},{}],5:[function(e,t,n){(function(e){"use strict";var n,r,o=e.MutationObserver||e.WebKitMutationObserver;if(o){var i=0,u=new o(f),c=e.document.createTextNode("");u.observe(c,{characterData:!0}),n=function(){c.data=i=++i%2}}else if(e.setImmediate||void 0===e.MessageChannel)n="document"in e&&"onreadystatechange"in e.document.createElement("script")?function(){var t=e.document.createElement("script");t.onreadystatechange=function(){f(),t.onreadystatechange=null,t.parentNode.removeChild(t),t=null},e.document.documentElement.appendChild(t)}:function(){setTimeout(f,0)};else{var s=new e.MessageChannel;s.port1.onmessage=f,n=function(){s.port2.postMessage(0)}}var a=[];function f(){var e,t;r=!0;for(var n=a.length;n;){for(t=a,a=[],e=-1;++e<n;)t[e]();n=a.length}r=!1}t.exports=function(e){1!==a.push(e)||r||n()}}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],6:[function(e,t,n){"function"==typeof Object.create?t.exports=function(e,t){e.super_=t,e.prototype=Object.create(t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}})}:t.exports=function(e,t){e.super_=t;var n=function(){};n.prototype=t.prototype,e.prototype=new n,e.prototype.constructor=e}},{}],7:[function(e,t,n){"use strict";var r=e("immediate");function o(){}var i={},u=["REJECTED"],c=["FULFILLED"],s=["PENDING"];function a(e){if("function"!=typeof e)throw new TypeError("resolver must be a function");this.state=s,this.queue=[],this.outcome=void 0,e!==o&&p(this,e)}function f(e,t,n){this.promise=e,"function"==typeof t&&(this.onFulfilled=t,this.callFulfilled=this.otherCallFulfilled),"function"==typeof n&&(this.onRejected=n,this.callRejected=this.otherCallRejected)}function l(e,t,n){r(function(){var r;try{r=t(n)}catch(t){return i.reject(e,t)}r===e?i.reject(e,new TypeError("Cannot resolve promise with itself")):i.resolve(e,r)})}function h(e){var t=e&&e.then;if(e&&("object"==typeof e||"function"==typeof e)&&"function"==typeof t)return function(){t.apply(e,arguments)}}function p(e,t){var n=!1;function r(t){n||(n=!0,i.reject(e,t))}function o(t){n||(n=!0,i.resolve(e,t))}var u=d(function(){t(o,r)});"error"===u.status&&r(u.value)}function d(e,t){var n={};try{n.value=e(t),n.status="success"}catch(e){n.status="error",n.value=e}return n}t.exports=a,a.prototype.catch=function(e){return this.then(null,e)},a.prototype.then=function(e,t){if("function"!=typeof e&&this.state===c||"function"!=typeof t&&this.state===u)return this;var n=new this.constructor(o);this.state!==s?l(n,this.state===c?e:t,this.outcome):this.queue.push(new f(n,e,t));return n},f.prototype.callFulfilled=function(e){i.resolve(this.promise,e)},f.prototype.otherCallFulfilled=function(e){l(this.promise,this.onFulfilled,e)},f.prototype.callRejected=function(e){i.reject(this.promise,e)},f.prototype.otherCallRejected=function(e){l(this.promise,this.onRejected,e)},i.resolve=function(e,t){var n=d(h,t);if("error"===n.status)return i.reject(e,n.value);var r=n.value;if(r)p(e,r);else{e.state=c,e.outcome=t;for(var o=-1,u=e.queue.length;++o<u;)e.queue[o].callFulfilled(t)}return e},i.reject=function(e,t){e.state=u,e.outcome=t;for(var n=-1,r=e.queue.length;++n<r;)e.queue[n].callRejected(t);return e},a.resolve=function(e){if(e instanceof this)return e;return i.resolve(new this(o),e)},a.reject=function(e){var t=new this(o);return i.reject(t,e)},a.all=function(e){var t=this;if("[object Array]"!==Object.prototype.toString.call(e))return this.reject(new TypeError("must be an array"));var n=e.length,r=!1;if(!n)return this.resolve([]);var u=new Array(n),c=0,s=-1,a=new this(o);for(;++s<n;)f(e[s],s);return a;function f(e,o){t.resolve(e).then(function(e){u[o]=e,++c!==n||r||(r=!0,i.resolve(a,u))},function(e){r||(r=!0,i.reject(a,e))})}},a.race=function(e){var t=this;if("[object Array]"!==Object.prototype.toString.call(e))return this.reject(new TypeError("must be an array"));var n=e.length,r=!1;if(!n)return this.resolve([]);var u=-1,c=new this(o);for(;++u<n;)s=e[u],t.resolve(s).then(function(e){r||(r=!0,i.resolve(c,e))},function(e){r||(r=!0,i.reject(c,e))});var s;return c}},{immediate:5}],8:[function(e,t,n){"use strict";for(var r={},o=["Boolean","Number","String","Function","Array","Date","RegExp","Object","Error"],i=0;i<o.length;i++){var u=o[i];r["[object "+u+"]"]=u.toLowerCase()}var c=r.toString,s=r.hasOwnProperty;function a(e){return null===e?String(e):"object"==typeof e||"function"==typeof e?r[c.call(e)]||"object":typeof e}function f(e){if(!e||"object"!==a(e)||e.nodeType||null!==(t=e)&&t===t.window)return!1;var t,n;try{if(e.constructor&&!s.call(e,"constructor")&&!s.call(e.constructor.prototype,"isPrototypeOf"))return!1}catch(e){return!1}for(n in e);return void 0===n||s.call(e,n)}function l(e){return"function"===a(e)}var h=Array.isArray||function(e){return"array"===a(e)};function p(e,t,n){var r,o,i,u,c,s,a,p=t[0]||{},d=1,v=t.length,y=!1,m=/\d+/;for("boolean"==typeof p&&(y=p,p=t[1]||{},d=2),"object"==typeof p||l(p)||(p={}),v===d&&(p=this,--d);d<v;d++)if(null!=(r=t[d]))for(o in a=h(r),r)if(!(o in Object.prototype)){if(a&&!m.test(o))continue;if(i=p[o],p===(u=r[o]))continue;y&&u&&(f(u)||(c=h(u)))?(c?(c=!1,s=i&&h(i)?i:[]):s=i&&f(i)?i:{},e.push({args:[y,s,u],result:{container:p,key:o}})):void 0!==u&&(h(r)&&l(u)||(p[o]=u))}n.container[n.key]=p}t.exports=function(){for(var e=[],t=-1,n=arguments.length,r=new Array(n);++t<n;)r[t]=arguments[t];var o,i={};for(e.push({args:r,result:{container:i,key:"key"}});o=e.pop();)p(e,o.args,o.result);return i.key}},{}],9:[function(e,t,n){"use strict";var r,o=(r=e("lie"))&&"object"==typeof r&&"default"in r?r.default:r,i="function"==typeof Promise?Promise:o;t.exports=i},{lie:7}],10:[function(e,t,n){var r,o,i=t.exports={};function u(){throw new Error("setTimeout has not been defined")}function c(){throw new Error("clearTimeout has not been defined")}function s(e){if(r===setTimeout)return setTimeout(e,0);if((r===u||!r)&&setTimeout)return r=setTimeout,setTimeout(e,0);try{return r(e,0)}catch(t){try{return r.call(null,e,0)}catch(t){return r.call(this,e,0)}}}!function(){try{r="function"==typeof setTimeout?setTimeout:u}catch(e){r=u}try{o="function"==typeof clearTimeout?clearTimeout:c}catch(e){o=c}}();var a,f=[],l=!1,h=-1;function p(){l&&a&&(l=!1,a.length?f=a.concat(f):h=-1,f.length&&d())}function d(){if(!l){var e=s(p);l=!0;for(var t=f.length;t;){for(a=f,f=[];++h<t;)a&&a[h].run();h=-1,t=f.length}a=null,l=!1,function(e){if(o===clearTimeout)return clearTimeout(e);if((o===c||!o)&&clearTimeout)return o=clearTimeout,clearTimeout(e);try{o(e)}catch(t){try{return o.call(null,e)}catch(t){return o.call(this,e)}}}(e)}}function v(e,t){this.fun=e,this.array=t}function y(){}i.nextTick=function(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var n=1;n<arguments.length;n++)t[n-1]=arguments[n];f.push(new v(e,t)),1!==f.length||l||s(d)},v.prototype.run=function(){this.fun.apply(null,this.array)},i.title="browser",i.browser=!0,i.env={},i.argv=[],i.version="",i.versions={},i.on=y,i.addListener=y,i.once=y,i.off=y,i.removeListener=y,i.removeAllListeners=y,i.emit=y,i.prependListener=y,i.prependOnceListener=y,i.listeners=function(e){return[]},i.binding=function(e){throw new Error("process.binding is not supported")},i.cwd=function(){return"/"},i.chdir=function(e){throw new Error("process.chdir is not supported")},i.umask=function(){return 0}},{}],11:[function(e,t,n){"use strict";t.exports=function(e,t,n){return 0===e.length?e:t?(n||e.sort(t),function(e,t){for(var n=1,r=e.length,o=e[0],i=e[0],u=1;u<r;++u)if(i=o,t(o=e[u],i)){if(u===n){n++;continue}e[n++]=o}return e.length=n,e}(e,t)):(n||e.sort(),function(e){for(var t=1,n=e.length,r=e[0],o=e[0],i=1;i<n;++i,o=r)if(o=r,(r=e[i])!==o){if(i===t){t++;continue}e[t++]=r}return e.length=t,e}(e))}},{}]},{},[2])(2)});
