!function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this).RelationalPouch=e()}}(function(){return function i(u,c,s){function a(n,e){if(!c[n]){if(!u[n]){var t="function"==typeof require&&require;if(!e&&t)return t(n,!0);if(f)return f(n,!0);var r=new Error("Cannot find module '"+n+"'");throw r.code="MODULE_NOT_FOUND",r}var o=c[n]={exports:{}};u[n][0].call(o.exports,function(e){var t=u[n][1][e];return a(t||e)},o,o.exports,i,u,c,s)}return c[n].exports}for(var f="function"==typeof require&&require,e=0;e<s.length;e++)a(s[e]);return a}({1:[function(e,t,n){"use strict";function r(){this.store={}}function o(){this.store=new r}n.Map=r,n.Set=o,r.prototype.mangle=function(e){if("string"!=typeof e)throw new TypeError("key must be a string but Got "+e);return"$"+e},r.prototype.unmangle=function(e){return e.substring(1)},r.prototype.get=function(e){var t=this.mangle(e);return t in this.store?this.store[t]:void 0},r.prototype.set=function(e,t){var n=this.mangle(e);return this.store[n]=t,!0},r.prototype.has=function(e){return this.mangle(e)in this.store},r.prototype.delete=function(e){var t=this.mangle(e);return t in this.store&&(delete this.store[t],!0)},r.prototype.forEach=function(n){var r=this;Object.keys(r.store).forEach(function(e){var t=r.store[e];e=r.unmangle(e),n(t,e)})},o.prototype.add=function(e){return this.store.set(e,!0)},o.prototype.has=function(e){return this.store.has(e)},o.prototype.delete=function(e){return this.store.delete(e)}},{}],2:[function(e,t,n){"use strict";var h=e("./pouch-utils"),p=h.extend,d=h.Promise,v=e("./collections"),y=e("./uuid"),m=e("uniq");var r=16,o="0",i="1",u="2",c="3";function g(e,t){var n=e.replace("_","")+"_";if("number"==typeof t){for(t=t.toString();t.length<r;)t="0"+t;n+=i+"_"+t}else n+=void 0===t?o:"object"==typeof t?c:u+"_"+t;return n}function w(e){var t=e.indexOf("_"),n=e.charAt(t+1),r=e.substring(t+3);return n===i?parseInt(r,10):r}n.setSchema=function(i){var c=this,u=new v.Map;function o(i,u){var e={};(u=p(!0,{},u)).rev&&(e._rev=u.rev,delete u.rev),u.attachments&&(e._attachments=u.attachments,delete u.attachments);var t=u.id||y();return delete u.id,e._id=g(i.documentType,t),i.relations&&Object.keys(i.relations).forEach(function(e){var t=i.relations[e],n=Object.keys(t)[0];if("belongsTo"===n)u[e]&&void 0!==u[e].id&&(u[e]=u[e].id);else{var r=t[n];if(r.options&&r.options.queryInverse)return void delete u[e];if(u[e]){var o=u[e].map(function(e){return e&&void 0!==e.id?e.id:e});u[e]=o}else u[e]=[]}}),e.data=u,e}function s(e){if(!u.has(e))throw function(e){var t=new Error(e);return t.status=400,t}("unknown type: "+JSON.stringify(e));return u.get(e)}function r(e,t,n){var r=s(e),o={include_docs:!0};return null==t?(o.startkey=g(r.documentType),o.endkey=g(r.documentType,{})):Array.isArray(t)?o.keys=t.map(function(e){return g(r.documentType,e)}):"object"==typeof t?(void 0===t.startkey||null===t.startkey?o.startkey=g(r.documentType):o.startkey=g(r.documentType,t.startkey),void 0===t.endkey||null===t.endkey?o.endkey=g(r.documentType,{}):o.endkey=g(r.documentType,t.endkey),void 0!==t.limit&&null!==t.limit&&(o.limit=t.limit),void 0!==t.skip&&null!==t.skip&&(o.skip=t.skip)):o.key=g(r.documentType,t),c.allDocs(o).then(function(e,t,n){return a(e,t,n.rows.filter(function(e){return e.doc&&!e.value.deleted}).map(function(e){return e.doc}))}.bind(c,e,n))}function a(t,a,n){var f=s(t);return a.has(t)||a.set(t,new v.Map),d.resolve().then(function(){var e=n.map(function(e){var c=function(e){var t=e.data;return t.id=w(e._id),t.rev=e._rev,e._attachments&&(t.attachments=e._attachments),t}(e);a.get(t).set(JSON.stringify(c.id),c);var s=[];return Object.keys(f.relations||{}).forEach(function(e){var t=f.relations[e],n=Object.keys(t)[0],r=t[n],o={};if("string"!=typeof r){if((o=r.options||{}).async)return;o.queryInverse&&delete c[e],r=r.type}if("belongsTo"===n){var i=c[e];void 0!==i&&s.push(d.resolve().then(function(){if(!a.has(r)||!a.get(r).has(JSON.stringify(i)))return{relatedType:r,relatedIds:[i]}}))}else{if(o.queryInverse)return void s.push(l(r,o.queryInverse,c.id,a).then(function(){}));var u=p(!0,[],c[e]);void 0!==u&&u.length&&s.push(d.resolve().then(function(){for(var e=u.length-1;0<=e;e--){var t=u[e];a.has(r)&&a.get(r).has(JSON.stringify(t))&&delete u[e]}if((u=u.filter(function(e){return void 0!==e})).length)return{relatedType:r,relatedIds:u}}))}}),d.all(s)});return d.all(e)}).then(function(e){var n={};return e.forEach(function(e){e.forEach(function(e){e&&(n[e.relatedType]=(n[e.relatedType]||[]).concat(e.relatedIds))})}),h.series(Object.keys(n).map(function(e){var t=m(n[e]);return function(){return r(e,t,a)}})).then(function(){var o={};return a.forEach(function(e,t){var n=s(t),r=o[n.plural]=[];e.forEach(function(e){r.push(e)})}),o})})}function l(t,e,n,r){var o={_id:{$gt:f({type:t}),$lt:f({type:t,id:{}})}};return o["data."+e]=n,c.find({selector:o}).then(function(e){return a(t,r,e.docs)})}function f(e){var t=e.type,n=u.get(t);return n&&(t=n.documentType),g(t,e.id)}i.forEach(function(e){u.set(e.singular,e),u.set(e.plural,e)}),i.forEach(function(e){e.documentType=e.documentType||e.singular}),i.forEach(function(o){if(o.relations){if(!Object.keys(o.relations).length)throw new Error("Invalid relations for: "+o);Object.keys(o.relations).forEach(function(e){var t=o.relations[e];if(1!==Object.keys(t).length)throw new Error("Invalid relationship definition for: "+e);var n=Object.keys(t)[0],r=t[n];if("string"!=typeof r&&(r=r.type),!u.get(r))throw new Error("Unknown entity type: "+r);if("belongsTo"!==n&&"hasMany"!==n)throw new Error("Invalid relationship type for "+e+": "+n)})}}),c.rel={save:function(e,t){return d.resolve().then(function(){return function(e,n){var t,r=s(e);return d.resolve().then(function(){return t=o(r,n),c.put(t)}).then(function(e){var t={};return t[r.plural]=[p(!0,n,{id:w(e.id),rev:e.rev})],t})}(e,t)})},find:function(e,t){return d.resolve().then(function(){return r(s(e).singular,t,new v.Map)})},findHasMany:function(e,t,n){return l(e,t,n,new v.Map)},del:function(e,t){return d.resolve().then(function(){return function(e,t){var n,r=s(e);return d.resolve().then(function(){return n={_id:(n=o(r,t))._id,_rev:n._rev,_deleted:!0},c.put(n)}).then(function(){return{deleted:!0}})}(e,t)})},getAttachment:function(e,t,n,r){return r=r||{},d.resolve().then(function(){return c.getAttachment(g(e,t),n,r)})},putAttachment:function(e,n,t,r,o){var i=g(e,n.id),u=s(e);return d.resolve().then(function(){return c.putAttachment(i,t,n.rev,r,o)}).then(function(e){var t={};return t[u.plural]=[p(!0,n,{id:w(e.id),rev:e.rev})],t})},removeAttachment:function(e,n,t){var r=g(e,n.id),o=s(e);return d.resolve().then(function(){return c.removeAttachment(r,t,n.rev)}).then(function(e){var t={};return t[o.plural]=[p(!0,n,{id:w(e.id),rev:e.rev})],t})},parseDocID:function(e){var t=e.indexOf("_"),n=e.substring(0,t),r=w(e);if(!u.get(n)){var o=i.filter(function(e){return e.documentType===n});0<o.length&&(n=o[0].singular)}return{type:n,id:r}},makeDocID:f,parseRelDocs:function(e,t){return a(e,new v.Map,t)},isDeleted:function(e,t){var n=s(e);return c.get(g(n.documentType,t)).then(function(e){return!!e._deleted}).catch(function(e){return"deleted"===e.reason||null})},uuid:y}},"undefined"!=typeof window&&window.PouchDB&&window.PouchDB.plugin(n)},{"./collections":1,"./pouch-utils":3,"./uuid":4,uniq:11}],3:[function(e,t,s){(function(u){"use strict";var c=e("pouchdb-promise");s.once=function(t){var n=!1;return s.getArguments(function(e){if(n)throw console.trace(),new Error("once called  more than once");n=!0,t.apply(this,e)})},s.getArguments=function(r){return function(){for(var e=arguments.length,t=new Array(e),n=-1;++n<e;)t[n]=arguments[n];return r.call(this,t)}},s.toPromise=function(i){return s.getArguments(function(t){var n,o=this,r="function"==typeof t[t.length-1]&&t.pop();r&&(n=function(e,t){u.nextTick(function(){r(e,t)})});var e=new c(function(n,r){try{var e=s.once(function(e,t){e?r(e):n(t)});t.push(e),i.apply(o,t)}catch(e){r(e)}});return n&&e.then(function(e){n(null,e)},n),e.cancel=function(){return this},e})},s.series=function(n){var r=s.Promise.resolve(),o=new Array(n.length);return n.forEach(function(e,t){r=r.then(n[t]).then(function(e){o[t]=e})}),r.then(function(){return o})},s.inherits=e("inherits"),s.Promise=c,s.extend=e("pouchdb-extend")}).call(this,e("_process"))},{_process:10,inherits:6,"pouchdb-extend":7,"pouchdb-promise":8}],4:[function(e,t,n){"use strict";var o="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split("");function i(e){return 0|Math.random()*e}t.exports=function(e,t){t=t||o.length;var n="",r=-1;if(e){for(;++r<e;)n+=o[i(t)];return n}for(;++r<36;)switch(r){case 8:case 13:case 18:case 23:n+="-";break;case 19:n+=o[3&i(16)|8];break;default:n+=o[i(16)]}return n}},{}],5:[function(e,f,t){(function(t){"use strict";var n,r,e=t.MutationObserver||t.WebKitMutationObserver;if(e){var o=0,i=new e(a),u=t.document.createTextNode("");i.observe(u,{characterData:!0}),n=function(){u.data=o=++o%2}}else if(t.setImmediate||void 0===t.MessageChannel)n="document"in t&&"onreadystatechange"in t.document.createElement("script")?function(){var e=t.document.createElement("script");e.onreadystatechange=function(){a(),e.onreadystatechange=null,e.parentNode.removeChild(e),e=null},t.document.documentElement.appendChild(e)}:function(){setTimeout(a,0)};else{var c=new t.MessageChannel;c.port1.onmessage=a,n=function(){c.port2.postMessage(0)}}var s=[];function a(){var e,t;r=!0;for(var n=s.length;n;){for(t=s,s=[],e=-1;++e<n;)t[e]();n=s.length}r=!1}f.exports=function(e){1!==s.push(e)||r||n()}}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],6:[function(e,t,n){"function"==typeof Object.create?t.exports=function(e,t){e.super_=t,e.prototype=Object.create(t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}})}:t.exports=function(e,t){e.super_=t;function n(){}n.prototype=t.prototype,e.prototype=new n,e.prototype.constructor=e}},{}],7:[function(e,t,n){"use strict";for(var r={},o=["Boolean","Number","String","Function","Array","Date","RegExp","Object","Error"],i=0;i<o.length;i++){var u=o[i];r["[object "+u+"]"]=u.toLowerCase()}var c=r.toString,s=r.hasOwnProperty;function a(e){return null===e?String(e):"object"==typeof e||"function"==typeof e?r[c.call(e)]||"object":typeof e}function v(e){if(!e||"object"!==a(e)||e.nodeType||function(e){return null!==e&&e===e.window}(e))return!1;try{if(e.constructor&&!s.call(e,"constructor")&&!s.call(e.constructor.prototype,"isPrototypeOf"))return!1}catch(e){return!1}var t;for(t in e);return void 0===t||s.call(e,t)}function y(e){return"function"===a(e)}var m=Array.isArray||function(e){return"array"===a(e)};function f(e,t,n){var r,o,i,u,c,s,a,f=t[0]||{},l=1,h=t.length,p=!1,d=/\d+/;for("boolean"==typeof f&&(p=f,f=t[1]||{},l=2),"object"==typeof f||y(f)||(f={}),h===l&&(f=this,--l);l<h;l++)if(null!=(r=t[l]))for(o in a=m(r),r)if(!(o in Object.prototype)){if(a&&!d.test(o))continue;if(i=f[o],f===(u=r[o]))continue;p&&u&&(v(u)||(c=m(u)))?(s=c?(c=!1,i&&m(i)?i:[]):i&&v(i)?i:{},e.push({args:[p,s,u],result:{container:f,key:o}})):void 0!==u&&(m(r)&&y(u)||(f[o]=u))}n.container[n.key]=f}t.exports=function(){for(var e=[],t=-1,n=arguments.length,r=new Array(n);++t<n;)r[t]=arguments[t];var o,i={};for(e.push({args:r,result:{container:i,key:"key"}});o=e.pop();)f(e,o.args,o.result);return i.key}},{}],8:[function(e,t,n){"use strict";var r,o=(r=e("lie"))&&"object"==typeof r&&"default"in r?r.default:r,i="function"==typeof Promise?Promise:o;t.exports=i},{lie:9}],9:[function(e,t,n){"use strict";var o=e("immediate");function a(){}var f={},i=["REJECTED"],u=["FULFILLED"],r=["PENDING"];function c(e){if("function"!=typeof e)throw new TypeError("resolver must be a function");this.state=r,this.queue=[],this.outcome=void 0,e!==a&&p(this,e)}function s(e,t,n){this.promise=e,"function"==typeof t&&(this.onFulfilled=t,this.callFulfilled=this.otherCallFulfilled),"function"==typeof n&&(this.onRejected=n,this.callRejected=this.otherCallRejected)}function l(t,n,r){o(function(){var e;try{e=n(r)}catch(e){return f.reject(t,e)}e===t?f.reject(t,new TypeError("Cannot resolve promise with itself")):f.resolve(t,e)})}function h(e){var t=e&&e.then;if(e&&("object"==typeof e||"function"==typeof e)&&"function"==typeof t)return function(){t.apply(e,arguments)}}function p(t,e){var n=!1;function r(e){n||(n=!0,f.reject(t,e))}function o(e){n||(n=!0,f.resolve(t,e))}var i=d(function(){e(o,r)});"error"===i.status&&r(i.value)}function d(e,t){var n={};try{n.value=e(t),n.status="success"}catch(e){n.status="error",n.value=e}return n}(t.exports=c).prototype.catch=function(e){return this.then(null,e)},c.prototype.then=function(e,t){if("function"!=typeof e&&this.state===u||"function"!=typeof t&&this.state===i)return this;var n=new this.constructor(a);this.state!==r?l(n,this.state===u?e:t,this.outcome):this.queue.push(new s(n,e,t));return n},s.prototype.callFulfilled=function(e){f.resolve(this.promise,e)},s.prototype.otherCallFulfilled=function(e){l(this.promise,this.onFulfilled,e)},s.prototype.callRejected=function(e){f.reject(this.promise,e)},s.prototype.otherCallRejected=function(e){l(this.promise,this.onRejected,e)},f.resolve=function(e,t){var n=d(h,t);if("error"===n.status)return f.reject(e,n.value);var r=n.value;if(r)p(e,r);else{e.state=u,e.outcome=t;for(var o=-1,i=e.queue.length;++o<i;)e.queue[o].callFulfilled(t)}return e},f.reject=function(e,t){e.state=i,e.outcome=t;for(var n=-1,r=e.queue.length;++n<r;)e.queue[n].callRejected(t);return e},c.resolve=function(e){if(e instanceof this)return e;return f.resolve(new this(a),e)},c.reject=function(e){var t=new this(a);return f.reject(t,e)},c.all=function(e){var n=this;if("[object Array]"!==Object.prototype.toString.call(e))return this.reject(new TypeError("must be an array"));var r=e.length,o=!1;if(!r)return this.resolve([]);var i=new Array(r),u=0,t=-1,c=new this(a);for(;++t<r;)s(e[t],t);return c;function s(e,t){n.resolve(e).then(function(e){i[t]=e,++u!==r||o||(o=!0,f.resolve(c,i))},function(e){o||(o=!0,f.reject(c,e))})}},c.race=function(e){var t=this;if("[object Array]"!==Object.prototype.toString.call(e))return this.reject(new TypeError("must be an array"));var n=e.length,r=!1;if(!n)return this.resolve([]);var o=-1,i=new this(a);for(;++o<n;)u=e[o],t.resolve(u).then(function(e){r||(r=!0,f.resolve(i,e))},function(e){r||(r=!0,f.reject(i,e))});var u;return i}},{immediate:5}],10:[function(e,t,n){var r,o,i=t.exports={};function u(){throw new Error("setTimeout has not been defined")}function c(){throw new Error("clearTimeout has not been defined")}function s(t){if(r===setTimeout)return setTimeout(t,0);if((r===u||!r)&&setTimeout)return r=setTimeout,setTimeout(t,0);try{return r(t,0)}catch(e){try{return r.call(null,t,0)}catch(e){return r.call(this,t,0)}}}!function(){try{r="function"==typeof setTimeout?setTimeout:u}catch(e){r=u}try{o="function"==typeof clearTimeout?clearTimeout:c}catch(e){o=c}}();var a,f=[],l=!1,h=-1;function p(){l&&a&&(l=!1,a.length?f=a.concat(f):h=-1,f.length&&d())}function d(){if(!l){var e=s(p);l=!0;for(var t=f.length;t;){for(a=f,f=[];++h<t;)a&&a[h].run();h=-1,t=f.length}a=null,l=!1,function(t){if(o===clearTimeout)return clearTimeout(t);if((o===c||!o)&&clearTimeout)return o=clearTimeout,clearTimeout(t);try{o(t)}catch(e){try{return o.call(null,t)}catch(e){return o.call(this,t)}}}(e)}}function v(e,t){this.fun=e,this.array=t}function y(){}i.nextTick=function(e){var t=new Array(arguments.length-1);if(1<arguments.length)for(var n=1;n<arguments.length;n++)t[n-1]=arguments[n];f.push(new v(e,t)),1!==f.length||l||s(d)},v.prototype.run=function(){this.fun.apply(null,this.array)},i.title="browser",i.browser=!0,i.env={},i.argv=[],i.version="",i.versions={},i.on=y,i.addListener=y,i.once=y,i.off=y,i.removeListener=y,i.removeAllListeners=y,i.emit=y,i.prependListener=y,i.prependOnceListener=y,i.listeners=function(e){return[]},i.binding=function(e){throw new Error("process.binding is not supported")},i.cwd=function(){return"/"},i.chdir=function(e){throw new Error("process.chdir is not supported")},i.umask=function(){return 0}},{}],11:[function(e,t,n){"use strict";t.exports=function(e,t,n){return 0===e.length?e:t?(n||e.sort(t),function(e,t){for(var n=1,r=e.length,o=e[0],i=e[0],u=1;u<r;++u)if(i=o,t(o=e[u],i)){if(u===n){n++;continue}e[n++]=o}return e.length=n,e}(e,t)):(n||e.sort(),function(e){for(var t=1,n=e.length,r=e[0],o=e[0],i=1;i<n;++i,o=r)if(o=r,(r=e[i])!==o){if(i===t){t++;continue}e[t++]=r}return e.length=t,e}(e))}},{}]},{},[2])(2)});
